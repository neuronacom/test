<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA Trade AI</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#fff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NEURONA Trade AI">
  <link rel="apple-touch-icon" href="https://i.ibb.co/XfKRzvcy/27.png">
  <link rel="icon" type="image/png" href="https://i.ibb.co/XfKRzvcy/27.png">
  <link rel="preload" as="image" href="https://i.ibb.co/Mk4WpHL9/25-1.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    html, body {width:100vw;height:100vh;margin:0;padding:0;overflow:hidden;background:#fff;}
    body {font-family:'Inter',sans-serif;color:#101010;position:relative;}
    #app {height:100vh;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;background:#fff;}
    .header {
      display:flex;align-items:center;gap:12px;padding:22px 18px 0 22px;min-height:70px;width:100vw;box-sizing:border-box;
      background:#fff;z-index:12;position:relative;border-bottom:1px solid #eee;
    }
    .logo {height:38px;width:38px;border-radius:12px;}
    .app-title {font-weight:700;font-size:1.45rem;letter-spacing:0.02em;}
    .ai-version-switcher {margin-left:18px;position:relative;}
    .ai-version-btn {
      background:#f6f7fa;border:none;font-weight:600;padding:7px 22px 7px 16px;border-radius:12px;font-size:0.98rem;
      color:#162447;cursor:pointer;display:flex;align-items:center;gap:9px;box-shadow:0 2px 8px #0001;
      transition:background 0.16s;
    }
    .ai-version-btn svg {width:16px;height:16px;stroke:#5e6470;}
    .ai-dropdown {display:none;position:absolute;top:38px;left:0;min-width:160px;background:#fff;border-radius:13px;
      box-shadow:0 3px 16px #0002;z-index:22;}
    .ai-dropdown.show {display:block;}
    .ai-dropdown-item {
      padding:10px 18px;cursor:pointer;font-size:1rem;color:#222;border-bottom:1px solid #f1f1f1;
      transition:background 0.14s;
    }
    .ai-dropdown-item:last-child {border-bottom:none;}
    .ai-dropdown-item.active {background:#e9f5ff;font-weight:700;color:#0b7dda;}
    .refresh-btn {
      margin-left:auto;background:none;border:none;cursor:pointer;padding:7px 9px;outline:none;transition:transform 0.2s;
    }
    .refresh-btn svg {width:24px;height:24px;stroke:#3b5998;}
    .lang-switcher {
      margin-left:16px;background:#f3f4f8;border-radius:10px;display:flex;align-items:center;overflow:hidden;
      box-shadow:0 2px 6px #0001;font-size:1rem;user-select:none;
    }
    .lang-btn {
      border:none;background:none;padding:5px 13px;cursor:pointer;font-weight:600;color:#324065;
      transition:background 0.12s,color 0.12s;
    }
    .lang-btn.active {background:#d3e8ff;color:#0074ff;}
    .push-indicator {margin-left:18px;font-size:1.1em;color:#27a87d;}
    .container {
      flex:1;display:flex;flex-direction:column;width:100vw;max-width:540px;margin:0 auto;background:#fff;overflow:hidden;
      transition:box-shadow 0.12s;
      box-shadow:0 5px 42px 0 #1b1b3c14;
    }
    .split-block {
      display:flex;flex-direction:column;height:100%;background:#fff;width:100%;overflow:hidden;gap:0;
    }
    .comments-block, .news-block {
      background:#f8faff;box-shadow:0 1px 8px #0001;overflow-y:auto;transition:background 0.13s;
      border-radius:0 0 26px 26px;box-sizing:border-box;padding:0;
    }
    .comments-block {flex:0 0 35%;min-height:33vh;max-height:35vh;border-radius:0 0 22px 22px;}
    .news-block {flex:1;min-height:0;height:65vh;max-height:100vh;border-radius:22px 22px 0 0;border-top:1px solid #f2f4fa;}
    .section-title {
      font-size:1.13em;font-weight:600;padding:18px 22px 8px 22px;letter-spacing:0.01em;color:#0072c6;
      text-shadow:0 1px 4px #fff5;
    }
    .comment-list, .news-list {margin:0;padding:0;list-style:none;width:100%;}
    .comment-list {padding:0 18px;}
    .comment-item {
      margin-bottom:15px;background:#e9f2fe;padding:12px 18px 13px 14px;border-radius:15px;box-shadow:0 2px 8px #0002;
      font-size:1.07em;line-height:1.6;position:relative;white-space:pre-line;
    }
    .comment-type {font-weight:700;color:#3ca0ff;}
    .trade-signal {
      background:#fff3e0;color:#ff8200;padding:9px 14px;border-radius:12px;font-weight:600;font-size:1.08em;box-shadow:0 2px 8px #0001;
      margin-bottom:6px;margin-right:14px;display:inline-block;
    }
    .news-list {padding:0 18px;}
    .news-item {
      margin-bottom:15px;background:#f7f7fd;padding:14px 19px 14px 16px;border-radius:15px;box-shadow:0 2px 8px #0001;
      font-size:1.05em;line-height:1.52;position:relative;transition:background 0.18s;
      display:flex;flex-direction:column;gap:4px;word-break:break-word;
    }
    .news-title {font-weight:600;font-size:1.04em;color:#244776;text-decoration:none;}
    .news-link {text-decoration:none;color:#3498e8;font-size:0.98em;}
    .news-meta {color:#4d576b;font-size:0.93em;margin-top:2px;}
    .news-time {color:#8a9399;font-size:0.92em;margin-left:10px;}
    .news-impact {color:#ff8a00;font-size:0.93em;margin-left:11px;}
    .notif-popup {
      position:fixed;top:16px;left:50%;transform:translateX(-50%);background:#222f3e;color:#fff;
      padding:13px 32px 12px 20px;border-radius:16px;box-shadow:0 4px 16px #0015;z-index:3333;
      font-size:1.09em;font-weight:600;opacity:0;pointer-events:none;transition:opacity 0.24s;
      display:flex;align-items:center;gap:13px;
    }
    .notif-popup.show {opacity:1;pointer-events:auto;}
    .notif-popup .pop-check {color:#16d28d;font-size:1.2em;}
    .notif-popup .pop-error {color:#ff4343;font-size:1.2em;}
    .loading-anim {
      width:44px;height:44px;border-radius:22px;border:5px solid #1ba2ff33;border-top:5px solid #ff9f43;
      animation:spin 1.1s linear infinite;margin:60px auto 0 auto;
    }
    @keyframes spin {
      0% {transform:rotate(0deg);}
      100% {transform:rotate(360deg);}
    }
    @media (max-width:640px) {
      .container {max-width:100vw;}
      .header {padding-left:9px;padding-right:9px;}
      .section-title {padding-left:10px;}
      .comment-list, .news-list {padding:0 6px;}
    }
    @media (max-width:480px) {
      .header {padding:13px 6px 0 7px;min-height:56px;}
      .section-title {padding-top:13px;font-size:1em;}
      .container {box-shadow:none;}
      .comments-block, .news-block {border-radius:12px;}
      .notif-popup {font-size:0.99em;}
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <img class="logo" src="https://i.ibb.co/XfKRzvcy/27.png" alt="logo"/>
      <span class="app-title" id="main-title">NEURONA Trade AI</span>
      <div class="ai-version-switcher">
        <button class="ai-version-btn" id="ai-version-btn">
          <span id="ai-version-label">Trade AI Bot</span>
          <svg viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9" fill="none" stroke-width="2"/></svg>
        </button>
        <div class="ai-dropdown" id="ai-dropdown">
          <div class="ai-dropdown-item active" data-version="trade">Trade AI Bot</div>
          <div class="ai-dropdown-item" data-version="base">NEURONA 1.0 (—á–∞—Ç—ã)</div>
        </div>
      </div>
      <button class="refresh-btn" id="refresh-btn" title="–û–±–Ω–æ–≤–∏—Ç—å">
        <svg viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9A9 9 0 0 1 21 6.13M20.49 15A9 9 0 0 1 3 17.87" fill="none" stroke-width="2"/></svg>
      </button>
      <div class="lang-switcher" id="lang-switcher">
        <button class="lang-btn active" data-lang="ru">RU</button>
        <button class="lang-btn" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="ua">UA</button>
      </div>
      <span class="push-indicator" id="push-indicator">üîî</span>
    </div>
    <div class="container">
      <div class="split-block">
        <div class="comments-block" id="comments-block">
          <div class="section-title" id="comment-section-title">AI –°–∏–≥–Ω–∞–ª—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
          <ul class="comment-list" id="comment-list"></ul>
        </div>
        <div class="news-block" id="news-block">
          <div class="section-title" id="news-section-title">–ö—Ä–∏–ø—Ç–æ –Ω–æ–≤–æ—Å—Ç–∏</div>
          <ul class="news-list" id="news-list"></ul>
        </div>
      </div>
    </div>
    <div class="notif-popup" id="notif-popup">
      <span class="pop-check">‚úîÔ∏è</span>
      <span id="notif-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã</span>
    </div>
  </div>
  <script>
    const langs = {
      ru: {
        'main-title': 'NEURONA Trade AI',
        'ai-version-label': 'Trade AI Bot',
        'comment-section-title': 'AI –°–∏–≥–Ω–∞–ª—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏',
        'news-section-title': '–ö—Ä–∏–ø—Ç–æ –Ω–æ–≤–æ—Å—Ç–∏',
        'notif-on': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã',
        'notif-off': '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã',
        'ai-version': ['Trade AI Bot', 'NEURONA 1.0 (—á–∞—Ç—ã)'],
        'btn-update': '–û–±–Ω–æ–≤–∏—Ç—å',
        'comment-no': '–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤',
        'news-no': '–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π'
      },
      en: {
        'main-title': 'NEURONA Trade AI',
        'ai-version-label': 'Trade AI Bot',
        'comment-section-title': 'AI Signals & Comments',
        'news-section-title': 'Crypto News',
        'notif-on': 'Notifications enabled',
        'notif-off': 'Notifications off',
        'ai-version': ['Trade AI Bot', 'NEURONA 1.0 (chats)'],
        'btn-update': 'Update',
        'comment-no': 'No signals',
        'news-no': 'No news'
      },
      ua: {
        'main-title': 'NEURONA Trade AI',
        'ai-version-label': 'Trade AI Bot',
        'comment-section-title': 'AI –°–∏–≥–Ω–∞–ª–∏ –π –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ',
        'news-section-title': '–ö—Ä–∏–ø—Ç–æ –Ω–æ–≤–∏–Ω–∏',
        'notif-on': '–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–æ',
        'notif-off': '–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ',
        'ai-version': ['Trade AI Bot', 'NEURONA 1.0 (—á–∞—Ç–∏)'],
        'btn-update': '–û–Ω–æ–≤–∏—Ç–∏',
        'comment-no': '–°–∏–≥–Ω–∞–ª—ñ–≤ –Ω–µ–º–∞—î',
        'news-no': '–ù–æ–≤–∏–Ω –Ω–µ–º–∞—î'
      }
    };
    let lang = localStorage.getItem('lang') || 'ru';
    let aiVersion = localStorage.getItem('aiVersion') || 'trade';
    function t(key) {
      return langs[lang][key] || key;
    }
    function setLang(l) {
      lang = l;
      localStorage.setItem('lang', l);
      document.getElementById('main-title').textContent = t('main-title');
      document.getElementById('ai-version-label').textContent = t('ai-version')[aiVersion === 'trade' ? 0 : 1];
      document.getElementById('comment-section-title').textContent = t('comment-section-title');
      document.getElementById('news-section-title').textContent = t('news-section-title');
      notifPopup(currentPushState ? t('notif-on') : t('notif-off'), currentPushState);
    }
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.lang-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        setLang(btn.dataset.lang);
      };
    });
    setLang(lang);

    let currentPushState = false;
    function notifPopup(txt, ok=true) {
      const pop = document.getElementById('notif-popup');
      document.getElementById('notif-text').textContent = txt;
      pop.querySelector('.pop-check').style.display = ok ? 'inline' : 'none';
      pop.querySelector('.pop-error').style.display = ok ? 'none' : 'inline';
      pop.classList.add('show');
      setTimeout(()=>pop.classList.remove('show'), 2100);
    }

    function setPushState(enabled) {
      currentPushState = enabled;
      document.getElementById('push-indicator').textContent = enabled ? 'üîî' : 'üîï';
      notifPopup(enabled ? t('notif-on') : t('notif-off'), enabled);
    }

    function askPushPermission() {
      if (!('Notification' in window)) return;
      Notification.requestPermission().then(permission => {
        setPushState(permission === 'granted');
      });
    }
    document.getElementById('push-indicator').onclick = askPushPermission;
    if ('Notification' in window) {
      setPushState(Notification.permission === 'granted');
    }

    function formatDate(d) {
      if (!d) return '';
      let dt = new Date(d);
      if (isNaN(dt)) return '';
      const now = new Date();
      const dd = dt.getDate().toString().padStart(2,'0');
      const mm = (dt.getMonth()+1).toString().padStart(2,'0');
      const yy = dt.getFullYear();
      const hh = dt.getHours().toString().padStart(2,'0');
      const min = dt.getMinutes().toString().padStart(2,'0');
      if (now.toDateString() === dt.toDateString())
        return `${hh}:${min}`;
      return `${dd}.${mm}.${yy} ${hh}:${min}`;
    }

    // AI Version Switcher
    const aiBtn = document.getElementById('ai-version-btn');
    const aiDropdown = document.getElementById('ai-dropdown');
    aiBtn.onclick = () => {
      aiDropdown.classList.toggle('show');
    };
    aiDropdown.querySelectorAll('.ai-dropdown-item').forEach(item=>{
      item.onclick = () => {
        aiDropdown.querySelectorAll('.ai-dropdown-item').forEach(i=>i.classList.remove('active'));
        item.classList.add('active');
        aiDropdown.classList.remove('show');
        aiVersion = item.dataset.version;
        localStorage.setItem('aiVersion', aiVersion);
        document.getElementById('ai-version-label').textContent = t('ai-version')[aiVersion === 'trade' ? 0 : 1];
        document.getElementById('comment-section-title').textContent = t('comment-section-title');
        renderMain();
      };
    });

    // REFRESH
    document.getElementById('refresh-btn').onclick = () => {
      renderMain(true);
    };

    // MAIN LOGIC
    async function getNews() {
      try {
        let r = await fetch('/api/news');
        let js = await r.json();
        return js.articles || [];
      } catch {
        return [];
      }
    }
    async function getSignalsAndComments() {
      // –î–µ–º–æ-–ª–æ–≥–∏–∫–∞: –≤—ã–¥–∞—ë–º —Ñ–µ–π–∫–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏ AI-–∫–æ–º–º–µ–Ω—Ç—ã, –µ—Å–ª–∏ aiVersion == 'trade'
      if (aiVersion !== 'trade') {
        return [{type:'text',text:t('comment-no')}];
      }
      // –ú–æ–∂–Ω–æ —Ç—É—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ –∏–∑ API /api/openai
      return [
        {type:'signal',signal:'LONG',entry:'110805',tp:'111900',sl:'109900',why:'BTC –≤—ã–∫—É–ø–ª–µ–Ω –æ—Ç 110k. –û–∂–∏–¥–∞–Ω–∏–µ —Ä–æ—Å—Ç–∞ –ø–æ —Å—Ç–∞–∫–∞–Ω—É –∏ –æ–±—ä—ë–º—É.'},
        {type:'signal',signal:'SHORT',entry:'111900',tp:'110000',sl:'112500',why:'–ü—Ä–æ–±–∏—Ç–∞ –∑–æ–Ω–∞ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –Ω–∞ 112000. –ö–æ—Ä—Ä–µ–∫—Ü–∏—è.'},
        {type:'text',text:'–ü–æ —Å—Ç–∞–∫–∞–Ω—É Binance –∏–¥—ë—Ç —Ä–µ–∑–∫–∏–π —Ä–æ—Å—Ç –ø–æ–∫—É–ø–æ–∫, –æ–±—ä—ë–º –≤ –ª–µ–Ω—Ç–µ —É–≤–µ–ª–∏—á–∏–ª—Å—è –≤ 1.6 —Ä–∞–∑–∞.'}
      ];
    }

    async function renderMain(force=false) {
      document.getElementById('comment-list').innerHTML = '<div class="loading-anim"></div>';
      document.getElementById('news-list').innerHTML = '<div class="loading-anim"></div>';
      setTimeout(async()=>{
        // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏/—Å–∏–≥–Ω–∞–ª—ã
        let comments = await getSignalsAndComments();
        let clist = '';
        for(const c of comments) {
          if (c.type === 'signal') {
            clist += `<li class="comment-item">
              <div class="trade-signal">${c.signal}</div>
              <div><b>–í—Ö–æ–¥:</b> ${c.entry}<br><b>TP:</b> ${c.tp}<br><b>SL:</b> ${c.sl}</div>
              <div style="margin-top:7px;color:#5e6d85;">${c.why||''}</div>
            </li>`;
          }
          else {
            clist += `<li class="comment-item">${c.text}</li>`;
          }
        }
        document.getElementById('comment-list').innerHTML = clist || `<li class="comment-item">${t('comment-no')}</li>`;

        // –ù–æ–≤–æ—Å—Ç–∏
        let news = await getNews();
        let nlist = '';
        news.reverse().forEach(n=>{
          nlist += `<li class="news-item">
            <a href="${n.url||'#'}" class="news-title" target="_blank" rel="noopener">${n.title||''}</a>
            <div class="news-meta">
              <span>${n.source||''}</span>
              <span class="news-time">${formatDate(n.time||'')}</span>
              ${n.impact?`<span class="news-impact">${n.impact}</span>`:''}
            </div>
          </li>`;
        });
        document.getElementById('news-list').innerHTML = nlist || `<li class="news-item">${t('news-no')}</li>`;
        document.getElementById('news-block').scrollTop = document.getElementById('news-block').scrollHeight;
      }, 440);
    }
    renderMain();

    setInterval(()=>{ renderMain(); }, 60*1000);

    // PUSH + SW
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(function() {
        // ok
      });
    }
    window.addEventListener('load', function() {
      if ('Notification' in window && Notification.permission !== 'granted') {
        setTimeout(()=>notifPopup(t('notif-off'), false), 1000);
      }
    });

    // SW PUSH
    navigator.serviceWorker && navigator.serviceWorker.ready.then(function(swreg){
      if ('PushManager' in window) {
        // SW push –ø–æ–¥–¥–µ—Ä–∂–∫–∞
      }
    });

    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª
    setTimeout(()=>{
      let newsBlock = document.getElementById('news-block');
      if(newsBlock) newsBlock.scrollTop = newsBlock.scrollHeight;
    }, 500);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º (no scroll)
    window.onresize = ()=> {
      document.body.scrollTop = 0; document.documentElement.scrollTop = 0;
    };
  </script>
</body>
</html>
