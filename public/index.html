<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA 1.0</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#fff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="NEURONA 1.0">
  <link rel="apple-touch-icon" href="https://i.ibb.co/XfKRzvcy/27.png">
  <link rel="icon" type="image/png" href="https://i.ibb.co/XfKRzvcy/27.png">
  <link rel="preload" as="image" href="https://i.ibb.co/Mk4WpHL9/25-1.png">
  <style>
* { box-sizing:border-box; margin:0; padding:0; }
    body, textarea, button, .msg-content {
      font-family: Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Noto Color Emoji', 'Noto Emoji', sans-serif;
    }
    html, body {
      width:100vw; height:100vh; min-height:100vh; min-width:100vw;
      background:#fff; color:#000;
      -webkit-font-smoothing:antialiased;
      -webkit-text-size-adjust:none;
      overflow:hidden;
    }
    body {
      width:100vw; height:100vh;
      display:flex; flex-direction:column;
      align-items:center; justify-content:flex-start;
      background-color:#fff !important; color:#000 !important;
      transition:background 0.22s cubic-bezier(.38,.85,.48,1.01),color 0.22s;
      position:relative;
      overflow:hidden;
    }
    #bg {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      z-index:0; opacity:0;
      transition:opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
      pointer-events:none;
    }
    #app {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100%;
      max-width: 360px;
      min-width: 230px;
      min-height: 420px;
      max-height: 92vh;
      height: 88vh;
      margin-top: 95px;
      margin-bottom: 18px;
      z-index:1; opacity:0;
      background: none;
      transition: opacity 1.4s cubic-bezier(.38,.85,.48,1.01);
      box-sizing: border-box;
    }
    body.shown #bg { opacity:0.27; }
    body.shown #app { opacity:1; }
    .top-bar {
      width:100vw; position:fixed; top:0; left:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between;
      background:transparent; height:56px; padding:0;
      pointer-events:none; transition:opacity .5s;
    }
    .top-bar-content {
      display:flex; align-items:center; height:56px; pointer-events:all;
      margin-left:18px;
    }
    .top-logo { width:36px; height:auto; margin-right:13px; transition:filter 0.18s;}
    .top-title {
      font-size:1.52rem; letter-spacing:.11em; font-weight:bold;
      color:#000; user-select:none;
      text-transform:uppercase;
      transition: color 0.18s;
    }
    .ai-version-selector {
      position: relative; display: flex; align-items: center; margin-left: 7px; z-index: 100;
    }
    .ai-version-btn {
      background: none; border: none; outline: none; cursor: pointer;
      display: flex; align-items: center; font-size: 1.17rem; font-weight: bold;
      color: inherit; padding: 0 4px;
    }
    .ai-version-arrow {
      margin-left: 2px; width: 18px; height: 18px;
      transition: transform .22s; opacity: 0.7;
      display:inline;
    }
    .ai-version-dropdown {
      position: absolute; top: 36px; left: 0; min-width: 190px;
      background: #fff; color: #222; border-radius: 12px;
      box-shadow: 0 3px 18px #0002; border: 1.2px solid #d7d7d7;
      z-index: 2222; display: none; flex-direction: column;
      animation:fade 0.4s;
    }
    .ai-version-dropdown.show { display: flex; }
    .ai-version-item {
      padding: 13px 16px; cursor: pointer; font-size: 1.04rem;
      font-weight: bold; transition: background .14s, color .14s;
      border-radius: 9px; color: #222; background: none;
      display: flex; flex-direction: column; align-items: flex-start;
    }
    .ai-version-item.active, .ai-version-item:active { background: #ededed; color: #242428; }
    .top-burger {
      display:flex; flex-direction:column; justify-content:center;
      width:36px; height:29px; margin-right:18px;
      cursor:pointer; pointer-events:all; gap:3.2px;
      z-index: 1110;
      transition: background 0.18s;
    }
    .top-burger span {
      display:block; height:5.6px; width:100%;
      background:#000; border-radius:4px; margin:0; transition:background 0.18s;
    }
    .top-burger span:last-child { margin-bottom:0; }
    .top-bar.hide { opacity:0; pointer-events:none; }
    #loader {
      position:fixed; inset:0; background:rgba(255,255,255,0.98);
      display:flex; align-items:center; justify-content:center;
      z-index:1001; flex-direction:column;
      opacity:1;
      transition: opacity .8s cubic-bezier(.33,1.17,.52,1.01), background .41s;
      pointer-events:auto;
      width: 100vw;
      height: 100vh;
    }
    #loader.hide {
      opacity:0; pointer-events:none;
      transition: opacity 1.3s cubic-bezier(.22,.7,.49,1.01);
    }
    .loader-content {
      display:flex; align-items:center; justify-content:center;
      animation:fade 8s ease-in-out infinite;
      min-height:140px; min-width:270px;
    }
    .loader-logo { width:110px; margin-right:18px; image-rendering: auto; transition: filter 0.18s;}
    .loader-text { display:flex; flex-direction:column; align-items:center; line-height:1.01; }
    .loader-title {
      font-size:5.3rem; font-weight:bold; letter-spacing:.14em; color:#000;
      text-shadow:0 1px 0 #fff, 0 4px 16px #bbb6;
      line-height:0.98; text-transform:uppercase;
      transition: color 0.18s;
    }
    .loader-subtitle {
      font-size:1.38rem; letter-spacing:.06em; color:#222; margin-top:5px;
      line-height:1.09; font-weight:500;
      transition: color 0.18s;
    }
    body.dark #loader, body.dark #loader .loader-content {
      background:#17181a !important;
    }
    body.dark #loaderLogo { filter: invert(1)!important; }
    body.dark #loaderTitle, body.dark #loaderSubtitle {
      color: #fff!important;
    }
    @keyframes fade { 0%,100%{opacity:0;} 50%{opacity:1;} }
    .trade-header {
      display:flex; flex-direction:column; align-items:flex-start; margin-bottom:8px;
    }
    .trade-title {
      font-size: 2.05rem; font-weight:bold; letter-spacing:.10em; color:#fff; text-transform:uppercase;
    }
    .trade-subtitle {
      font-size:.98rem; color:#b7b7b7; margin-top:2px; margin-left:1px; font-weight:500; letter-spacing:.03em;
    }
    .trade-windows {
      display:flex; flex-direction:column; gap:10px; width:100%; height:100%;
    }
    .trade-news, .trade-signals {
      background:rgba(255,255,255,0.93); border-radius:13px; border:1.6px solid #d1d1d1;
      box-shadow:0 7px 36px 0 rgba(30,40,80,0.19), 0 2.5px 10px 0 rgba(50,50,90,0.14);
      width:100%; min-width:0; padding:13px 13px 8px 13px; overflow-y:auto;
      box-sizing: border-box; font-size:1.01rem; min-height:85px;
      max-height:calc(45vh - 38px); transition:box-shadow .18s, border .18s, background .18s, color .18s;
      margin-bottom:2px;
    }
    .trade-signals { margin-bottom:0; }
    .trade-news { height: 32vh; }
    .trade-signals { height: 40vh; }
    .trade-news-list, .trade-signal-list {
      display: flex; flex-direction: column; gap: 9px; min-height: 30px;
    }
    .trade-news-item {
      font-family: Arial,sans-serif; font-size:1.02em;
      margin-bottom: 2px;
      padding: 0 0 1px 0;
      border-bottom: 1px solid #e7e7e7;
      position: relative;
    }
    .trade-news-link {
      font-weight: bold; color: #286be6; font-size: 1.02em; text-decoration: none;
    }
    .trade-news-source { font-size:.92em; color:#888; margin-left:7px; }
    .trade-news-time { font-size:.9em; color:#aaa; margin-left:11px; }
    .trade-signal-item { position:relative; font-size:1.04em; padding: 6px 0 10px 0; margin-bottom: 2px; border-bottom: 1px solid #e7e7e7;}
    .trade-signal-label { font-weight:bold; color:#17a92f; }
    .trade-signal-label.short { color:#e91e22; }
    .trade-signal-time { font-size:.91em; color:#888; margin-left:8px;}
    .trade-signal-dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#b7b7b7; margin-right:4px; }
    .trade-signal-dot.long { background:#17a92f; }
    .trade-signal-dot.short { background:#e91e22; }
    .trade-signal-entry { font-weight:bold; color:#3c3c3c; }
    .trade-signal-tp, .trade-signal-sl, .trade-signal-tf { color:#888; margin-left:6px;}
    .trade-signal-comment { margin-top:6px; font-size:.98em; color:#333; }
    .signal-typing {
      font-style:italic; color:#666; background:#ebebeb;
      min-height:28px; min-width:62px; border-radius:8px; margin:7px 0 0 0;
      padding:4px 8px; display: flex; align-items:flex-end; width:fit-content;
    }
    .trade-news::-webkit-scrollbar, .trade-signals::-webkit-scrollbar { width:6px; background:transparent;}
    .trade-news::-webkit-scrollbar-thumb, .trade-signals::-webkit-scrollbar-thumb { background:#d8d8d8; border-radius:3px;}
    body.dark .trade-news, body.dark .trade-signals { background:#22232a; color:#ececec; border-color:#323232;}
    body.dark .trade-news-item, body.dark .trade-signal-item { border-color:#23232b; }
    body.dark .trade-news-link { color:#68a6ff; }
    body.dark .trade-news-source, body.dark .trade-news-time, body.dark .trade-signal-time, body.dark .trade-signal-tp, body.dark .trade-signal-sl { color:#888;}
}
    @keyframes fade { 0%,100%{opacity:0;} 50%{opacity:1;} }
    .chat-container {
      background:rgba(255,255,255,0.93);
      border-radius:14px; border:1.6px solid #d1d1d1;
      box-shadow:0 7px 36px 0 rgba(30,40,80,0.19), 0 2.5px 10px 0 rgba(50,50,90,0.14);
      display:flex; flex-direction:column; overflow:hidden;
      width:100%; min-width:0; height:100%; min-height: 390px; max-height: 100%;
      transition: box-shadow 0.18s cubic-bezier(.3,.9,.3,1), border 0.18s, background 0.18s, color 0.18s;
      position:relative;
      margin:0 auto 0 auto;
      box-sizing: border-box;
      will-change:background,color,border;
    }
    #messages {
      flex:1; display:flex; flex-direction:column; padding:15px; overflow-y:auto;
      gap:7px; scroll-behavior: smooth;
      overscroll-behavior: contain;
      min-height: 100px;
      max-height: calc(88vh - 132px);
      box-sizing: border-box;
      transition:none;
      will-change:unset;
    }
    .message {
      display: flex;
      flex-direction: column;
      align-self: flex-start;
      position:relative;
      background:#e0e0e0;
      margin: 2px 0;
      padding:10px 15px 26px 12px;
      max-width:83%; min-width:70px;
      border-radius:12px 12px 12px 0;
      box-shadow:0 1.5px 5px #ccc3;
      word-break:break-word;
      line-height:1.48;
      font-size:1rem;
      color:#111;
      border:1.2px solid #d7d7d7;
      transition:background 0.18s, border 0.18s, color 0.18s;
      will-change:unset;
    }
    .message.user {
      align-self:flex-end;
      background:#f5f5f5;
      border-radius:12px 12px 0 12px;
      color:#222;
      border:1.2px solid #d7d7d7;
    }
    .message.bot  { align-self:flex-start; }
    .message.typing {
      font-style:italic; color:#666;
      background: #ebebeb;
      min-width:60px;
      padding-bottom:14px;
      height:38px;
      overflow:hidden;
      display: flex;
      align-items: flex-end;
    }
    .msg-content { width: 100%; padding-bottom: 3px; transition:none; }
    .msg-time {
      position:absolute;
      right:14px;
      bottom:6px;
      font-size:0.8em;
      color:#666;
      opacity:0.88;
      background:none !important;
      padding:0 2px 0 1px;
      border-radius: 6px;
      z-index:10;
      user-select:none;
      font-family:Arial,sans-serif;
      pointer-events: none;
      box-shadow: none;
      transition:.18s;
      display: none;
    }
    .neurona-title {
      font-weight:bold; font-size:2.05rem; letter-spacing:.10em; display:block;
      text-align:center; margin: 0 0 8px 0; text-transform:uppercase;
    }
    .input-area {
      display: flex;
      padding: 10px;
      background: #fff;
      align-items: flex-end;
      transition: background 0.18s;
    }
    body.dark .input-area { background: #1b1c1e; }
    #input {
      flex:1; resize:none; border:1px solid #ccc; padding:12px; border-radius:4px; height:50px; font-size:1rem;
      background: none;
      color: inherit;
      transition: background 0.18s, color 0.18s;
    }
    #send {
      margin-left:8px; padding:0 16px; border:none; border-radius:4px;
      background:#444; color:#fff; font-size:1rem; cursor:pointer; transition:background 0.18s,color 0.18s;
      min-width:44px; min-height:50px; height:50px; display: flex; align-items: center; justify-content: center;
      font-weight:bold;
      border:1.2px solid #d7d7d7;
    }
    body.dark #send { background:#fff; color:#000; border:1.2px solid #888;}
    #send:hover { background:#222; color:#fff; }
    body.dark #send:hover { background:#eee; color:#000; }
    .save-btn {
      margin: 13px 10px 8px 10px;
      padding:0 16px;
      border:none;
      border-radius:4px;
      background:#444;
      color:#fff;
      font-size:1rem;
      cursor:pointer;
      transition:background 0.23s,color 0.23s,opacity 0.35s, display 0.25s;
      min-width:44px; min-height:44px; height:44px;
      display: flex; align-items: center; justify-content: center;
      font-weight:bold;
      border:1.2px solid #d7d7d7;
      box-shadow: 0 2px 8px #0001;
      opacity:1;
      will-change: opacity, display;
    }
    .save-btn.hide {
      opacity:0;
      pointer-events: none;
      display: none;
      transition: opacity 0.45s cubic-bezier(.22,.7,.49,1.01), display 0.25s;
    }
    .save-btn.saving {
      background:#222;
      color:#fff;
      opacity:0.6;
      pointer-events: none;
      transition:background 0.23s, color 0.23s, opacity 0.23s;
    }
    body.dark .save-btn { background:#fff; color:#000; border:1.2px solid #888;}
    .save-btn:hover { background:#222; color:#fff; }
    body.dark .save-btn:hover { background:#eee; color:#000; }
    .copy-btn {
      position: absolute;
      top: 4px; right: 3px;
      background: none; border: none; cursor: pointer; color: #888; font-size: 1.47em; opacity: 0.95; z-index: 15;
      display:none;
      font-weight:bold;
      filter: drop-shadow(0 0 1.2px #0002);
      line-height:1;
      transition: font-size .22s, color .15s;
    }
    .message:hover .copy-btn { display:inline; }
    .message.user .copy-btn { color:#777; }
    .message.bot .copy-btn { color:#000; }
    .copy-btn.copied { font-size: 1.03em; color: #51a551; font-weight:normal; }
    .copy-btn svg { vertical-align: middle;}
    ol, ul {
      margin: 12px 0 12px 15px;
      padding-left: 24px;
    }
    ol { list-style: decimal inside; }
    ul { list-style: disc inside; }
    li { margin-bottom: 5px; line-height: 1.5; }
    p { margin: 7px 0; }
    #scroll-down {
      display:none; position:absolute; left:50%; bottom:93px;
      transform:translateX(-50%);
      background:#fff; color:#222;
      border-radius:50%; box-shadow:0 3px 14px #0001;
      width:47px; height:47px; align-items:center; justify-content:center;
      cursor:pointer; font-size:2.4rem; border:none; outline:none;
      transition:.3s cubic-bezier(.5,1.6,.4,1);
      opacity:0.93;
      z-index:99;
      border: 2.2px solid #eee;
      font-weight: bold;
      padding:0;
    }
    #scroll-down svg {
      width:27px; height:27px; display:block; stroke-width:4.2px;
      margin: 0 auto;
      transition:transform .48s cubic-bezier(.6,.8,.3,1.2);
    }
    #scroll-down.show { display:flex; }
    #scroll-down:active svg, #scroll-down.down-anim svg { transform: translateY(7px) scale(1.12); }
    #scroll-down:hover { background:#f0f0f0; }
    .side-menu-bg {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.22);
      z-index: 1101;
      opacity: 0; pointer-events: none;
      transition: opacity .30s;
    }
    .side-menu-bg.active {
      opacity: 1; pointer-events: auto;
    }
    .side-menu {
      position: fixed; top: 0; right: 0;
      width: 56vw; max-width: 420px; min-width: 230px;
      height: 100vh;
      background: var(--side-bg, #fff);
      color: var(--side-txt, #222);
      z-index: 1102;
      box-shadow: -9px 0 38px #0002;
      transform: translateX(120%);
      transition: transform .44s cubic-bezier(.64,.03,.32,1), background .22s, color .22s;
      display: flex; flex-direction: column;
      border-radius: 25px 0 0 25px;
      padding: 28px 0 0 0;
      overflow-y: auto;
      border-left: 1.8px solid #ededed;
    }
    .side-menu.active { transform: translateX(0); }
    .side-menu-list {
      display: flex; flex-direction: column;
      gap: 2px; margin: 0 0 18px 0; padding: 0 24px;
    }
    .side-menu-item {
      padding: 15px 0 12px 7px;
      font-size: 1.15rem;
      font-weight: bold;
      border-bottom: 1px solid #ececec;
      cursor: pointer; user-select: none;
      display: flex; align-items: center;
      gap: 12px;
      transition: background .15s;
      position: relative;
    }
    .side-menu-item:last-child { border-bottom: none; }
    .side-menu-item:active { background: #f7f7fa; }
    .side-arrow {
      margin-left: 6px;
      transition: transform .22s;
      opacity: 0.7;
      width: 18px;
      height: 18px;
      display:inline;
    }
    .side-menu-item.with-arrow .side-arrow { display:inline;}
    .side-menu-item .side-arrow { display:inline;}
    .side-menu-section {display:none;}
    .settings-group {
      display:none; flex-direction:column; gap:0; margin:0; padding:0 0 0 0;
      margin-bottom: 0;
      border-top:none;
    }
    .settings-group.open { display:flex; }
    .side-switch-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 0 8px 7px;
      border-bottom: none;
    }
    .side-switch-label { font-size: 1.06rem; font-weight: bold; display:flex; align-items:center;}
    .switch {
      width: 52px; height: 30px;
      border-radius: 18px;
      position: relative; cursor: pointer;
      margin-left: 5px;
      flex-shrink: 0;
      box-shadow: 0 1.5px 4px #0001;
      display: flex; align-items: center;
      transition: background 0.17s, border 0.17s;
      overflow: visible;
      will-change:unset;
      border: 1.4px solid #bcbcbc;
      background: #e3e3e7;
    }
    .switch.on { background: #f6f6f8; border-color: #a3a3a7; }
    .switch.notif { background: #e3e3e7; border-color:#bcbcbc; }
    .switch.notif.on { background: #f6f6f8; border-color: #a3a3a7; }
    .switch.theme { background: #e3e3e7; border-color:#bcbcbc; }
    .switch.theme.on { background: #23242a; border-color: #545458; }
    .switch-inner {
      width: 28px; height: 28px;
      position: absolute; left: 1.4px; top: -1px;
      box-shadow: 0 2.5px 12px #bbb2;
      transition: left .18s cubic-bezier(.64,.03,.32,1), background .16s, border .16s;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      will-change:unset;
      border-width: 1.8px;
      border-style: solid;
      background: #fff;
      border-color: #d2d2d2;
    }
    .switch.on .switch-inner { left: 22px; }
    .switch:not(.on) .switch-inner { left: 1.4px; }
    .switch.theme .switch-inner { background: #fff; border-color: #d2d2d2; }
    .switch.theme.on .switch-inner { background: #fff; border-color: #d2d2d2; }
    .switch.notif .switch-inner { background: #fff; border-color: #d2d2d2; }
    .switch.notif.on .switch-inner { background: #fff; border-color: #d2d2d2; }
    .switch-icon {
      width: 18px; height: 18px; display: flex; align-items: center; justify-content:center;
      pointer-events:none; user-select:none;
      opacity: 0.9; transition: opacity .15s;
      position: absolute; left: 5px; top: 4px;
    }
    .switch.theme .switch-inner .switch-icon.sun { display:inline;}
    .switch.theme .switch-inner .switch-icon.moon { display:none;}
    .switch.theme.on .switch-inner .switch-icon.sun { display:none;}
    .switch.theme.on .switch-inner .switch-icon.moon { display:inline;}
    .switch.theme .switch-inner .switch-icon { left: 5px; top: 4px; right:unset; }
    .switch.theme.on .switch-inner .switch-icon { left: 5px; top: 4px; right:unset; }
    body.dark {
      background: #17181a !important; color: #f2f2f2 !important;
      transition: background 0.22s cubic-bezier(.38,.85,.48,1.01),color 0.22s;
    }
    body.dark #app,
    body.dark .chat-container {
      background: #1b1c1e !important; color: #ececec;
      border-color: #323232;
      transition: background 0.18s, color 0.18s, border 0.18s;
    }
    body.dark .message, body.dark .message.user {
      background: #242428;
      color: #f5f5f7;
      border-color: #545458;
      transition: background 0.18s, color 0.18s, border 0.18s;
    }
    body.dark .message.user { background: #28282c; color: #eaeaea; }
    body.dark .side-menu {
      --side-bg:#16171a; --side-txt:#eee; --side-muted:#999;
      background: #16171a; color: #eee;
      border-left: 2.3px solid #323232;
    }
    body.dark .side-menu-item { border-bottom: 1.3px solid #23232b; color: #fff; }
    body.dark .side-menu-item:active { background: #23232b; }
    body.dark .side-switch-row, body.dark .side-menu-section { color: #bfc7d2; }
    .side-close-btn {
      position: absolute; top: 12px; right: 17px;
      width: 41px; height: 41px;
      background: none; border: none;
      font-size: 2.17rem; color: #888;
      cursor: pointer; border-radius: 100%;
      transition: background .15s;
      z-index: 1122;
      display: flex; align-items: center; justify-content: center;
    }
    .side-close-btn:active { background: #eee; }
    body.dark .side-close-btn { color: #aaa; }
    .side-langs {
      position: static;
      max-height: 0;
      overflow: hidden;
      border-radius: 14px;
      box-shadow: 0 3px 14px #0002;
      background: var(--side-bg, #fff);
      margin: 0 0 0 0;
      border: 1.1px solid #eee;
      left: 0; right: 0;
      z-index: 1111;
      display: block;
      width: 100%;
      opacity:0; pointer-events:none;
      transition: max-height 0.34s cubic-bezier(.4,0,.7,1), opacity 0.24s cubic-bezier(.4,0,.7,1);
    }
    .side-langs.show {
      max-height: 1000px;
      opacity:1;
      pointer-events:auto;
      padding: 2px 0 6px 0;
      overflow: visible;
      margin-bottom: 15px;
    }
    .side-lang-item {
      padding: 13px 15px; font-size: 1.08rem;
      cursor: pointer;
      color: var(--side-txt, #111);
      transition: background .13s, color .13s;
      border-radius: 8px;
      user-select: none;
      font-weight: bold;
      display: flex; align-items: center;
    }
    .side-lang-item.active, .side-lang-item:active {
      background: #ededed;
      color: #242428;
    }
    body.dark .side-langs { background: #16171a; border-color:#23252a; }
    body.dark .side-lang-item { color: #eee; }
    body.dark .side-lang-item.active, body.dark .side-lang-item:active {
      background: #262b35; color: #fff;
    }
    .side-lang-arrow {
      margin-left: 6px;
      width: 14px; height: 14px;
      opacity: 0.7;
      display: inline-block;
      vertical-align: middle;
      transition: transform .22s;
    }
    .side-lang-arrow.open { transform:rotate(180deg);}
    .curr-lang-gray {
      color: #888;
      font-size: 0.93em;
      margin-left: 6px;
      font-weight: normal;
      opacity: 0.77;
    }
    .notif-popup {
      position:fixed;
      left:50%; top:19%;
      transform:translate(-50%,-50%);
      min-width:210px; max-width:88vw;
      background:#0e0; color:#fff;
      border-radius:13px; box-shadow:0 2px 15px #0003;
      font-size:1.1rem; font-weight:bold;
      z-index:22222;
      padding:18px 22px 18px 20px;
      opacity:0; pointer-events:none; transition:.26s;
      display:flex; align-items:center; gap:13px;
    }
    .notif-popup.show {opacity:1; pointer-events:all;}
    .notif-popup svg{width:31px; height:31px;}
    .typing-dots {
      display: inline-flex;
      gap: 2.7px;
      vertical-align: middle;
      align-items: flex-end;
    }
    .tdot {
      display: inline-block;
      width: 7px;
      height: 7px;
      background: #bbb;
      border-radius: 50%;
      opacity: .7;
      animation: tdotbounce 1.1s infinite;
      margin-right: 2px;
    }
    .tdot1 { animation-delay: 0s;}
    .tdot2 { animation-delay: 0.15s;}
    .tdot3 { animation-delay: 0.33s;}
    @keyframes tdotbounce {
      0%,80%,100% { transform: translateY(0); opacity: .66; }
      35% { transform: translateY(-7px); opacity: 1;}
      50% { opacity: 1;}
    }
    @media(max-width:600px){
      .top-bar{height:38px;}
      .top-bar-content{height:38px; margin-left:7px;}
      .top-logo{width:22px; margin-right:7px;}
      .top-title{font-size:1.03rem;}
      .top-burger{width:27px; height:18px; margin-right:7px;}
      .top-burger span{height:3.3px;}
      #app { max-width:94vw; min-width:0; padding:0 0 7px 0; height:84vh; margin-top:79px; }
      .chat-container { min-width:0; max-width:100vw; min-height:150px; height:100%;}
      #messages { min-height:60px; max-height:calc(84vh - 110px);}
      .loader-logo { width:70px; margin-right:7px; }
      .loader-title { font-size:2.4rem; }
      .loader-subtitle { font-size:.98rem; }
      #input { font-size:.89rem; height:38px; }
      #send { font-size:.89rem; padding:0 10px; min-width:34px; min-height:38px; height:38px;}
      #scroll-down { width:35px; height:35px; font-size:1.3rem; bottom:82px;}
      #scroll-down svg { width:20px; height:20px; }
      #loader { min-height:280px; }
      .side-menu{ width:80vw; min-width:0; }
      .side-langs{ left: 0; right: 0; }
    }
    @media (max-width:400px){
      .loader-title{font-size:1.2rem;}
      #app{max-width:98vw;}
      .chat-container{min-height:80px;}
    }
    @media (max-height:450px){
      #app{min-height:100px; height:54vh;}
      .chat-container{min-height:60px;}
      #messages{min-height:35px;}
    }
  </style>
</head>
<body>
<canvas id="bg"></canvas>
<div class="top-bar" id="top-bar">
  <div class="top-bar-content">
    <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="top-logo" alt="logo" id="mainLogo"/>
    <span class="top-title" id="mainTitle">NEURONA</span>
    <span class="ai-version-selector" id="aiVersionSelector">
      <button class="ai-version-btn" id="aiVersionBtn">
        <span id="aiVersionBtnText">NEURONA 1.0</span>
        <svg class="ai-version-arrow" id="aiVersionArrow" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <div class="ai-version-dropdown" id="aiVersionDropdown">
        <div class="ai-version-item active" data-value="neurona1">NEURONA 1.0<br><span style="font-weight:normal; font-size:.92em; color:#888;">AI Chat Assistant</span></div>
        <div class="ai-version-item" data-value="tradeai">NEURONA Trade AI Bot<br><span style="font-weight:normal; font-size:.92em; color:#888;">Trade Signals &amp; Market News</span></div>
      </div>
    </span>
  </div>
  <div class="top-burger" id="burgerBtn">
    <span></span><span></span><span></span>
  </div>
</div>
<div class="side-menu-bg" id="sideMenuBg"></div>
<nav class="side-menu" id="sideMenu" tabindex="-1">
  <button class="side-close-btn" id="sideCloseBtn" title="Закрыть меню">&times;</button>
  <div class="side-menu-list" id="sideMenuList">
    <div class="side-menu-item" data-menu="profile">
      <span class="menu-text">Мой профиль</span>
    </div>
    <div class="side-menu-item" data-menu="subscription">
      <span class="menu-text">Подписка</span>
    </div>
    <div class="side-menu-item with-arrow" id="settingsBtn">
      <span class="menu-text">Настройки</span>
      <svg class="side-arrow" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </div>
    <div class="settings-group" id="settingsGroup">
      <div class="side-switch-row">
        <span class="side-switch-label menu-text">Уведомления</span>
        <div class="switch" id="notifSwitch">
          <div class="switch-inner"></div>
        </div>
      </div>
      <div class="side-switch-row">
        <span class="side-switch-label menu-text">Тема</span>
        <div class="switch" id="themeSwitch">
          <div class="switch-inner"></div>
        </div>
      </div>
      <div class="side-switch-row" id="langRow" style="cursor:pointer;">
        <span class="side-switch-label menu-text" style="display:flex;align-items:center;">
          <span id="currLangName"></span>
          <span class="curr-lang-gray" id="currLangGray"></span>
          <svg class="side-lang-arrow" id="langArrow" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="margin-left:5px;"><path d="M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
      </div>
      <div class="side-langs" id="langList"></div>
      <button class="save-btn hide" id="saveSettingsBtn">Сохранить изменения</button>
    </div>
  </div>
</nav>
<div id="loader">
  <div class="loader-content">
    <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="loader-logo" alt="Logo" id="loaderLogo" onload="this.style.opacity=1;" style="opacity:0;transition:opacity .4s;"/>
    <div class="loader-text">
      <div class="loader-title" id="loaderTitle">NEURONA</div>
      <div class="loader-subtitle" id="loaderSubtitle">PERSONAL AI ASSISTANT</div>
    </div>
  </div>
</div>
<div id="app">
  <div class="chat-container" id="mainChatContainer">
    <div id="messages"></div>
    <button id="scroll-down" title="Прокрутить вниз">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M7 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <div class="input-area">
      <textarea id="input" rows="1" maxlength="1200" autocomplete="off" placeholder="Введите вопрос или команду..."></textarea>
      <button id="send"><span>⏎</span></button>
    </div>
  </div>
  <div class="trade-windows" id="tradeWindows" style="display:none;">
    <div class="trade-header">
      <span class="trade-title" id="tradeTitle">NEURONA</span>
      <span class="trade-subtitle" id="tradeSubtitle">Trade AI Bot</span>
    </div>
    <div class="trade-news" id="tradeNews">
      <div class="trade-news-list" id="tradeNewsList"></div>
    </div>
    <div class="trade-signals" id="tradeSignals">
      <div class="trade-signal-list" id="tradeSignalList"></div>
    </div>
  </div>
</div>
<div class="notif-popup" id="notifPopup">
  <svg width="31" height="31" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 7v5l3 3"/></svg>
  <span id="notifPopupMsg">Уведомление!</span>
</div>
<script>
const canvas = document.getElementById('bg'), ctx = canvas.getContext('2d');
let W, H, nodes;
function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; }
window.addEventListener('resize', resize);
function init(){
  nodes = Array.from({length:33}).map(_=>({
    x:Math.random()*W, y:Math.random()*H,
    vx:(Math.random()-0.5)*0.6, vy:(Math.random()-0.5)*0.6
  }));
}
function draw(){
  ctx.clearRect(0,0,W,H);
  ctx.lineCap='round'; ctx.lineJoin='round';
  nodes.forEach((a,i)=>{
    nodes.slice(i+1).forEach(b=>{
      const dx=a.x-b.x, dy=a.y-b.y, d=Math.hypot(dx,dy);
      if(d<240){
        ctx.strokeStyle=`rgba(0,0,0,${Math.min(0.46,(240-d)/170)})`;
        ctx.lineWidth=2.1;
        ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
      }
    });
  });
  nodes.forEach(n=>{
    n.x+=n.vx; n.y+=n.vy;
    if(n.x<0||n.x>W) n.vx*=-1;
    if(n.y<0||n.y>H) n.vy*=-1;
    ctx.fillStyle='rgba(0,0,0,0.95)';
    ctx.beginPath(); ctx.arc(n.x,n.y,4.4,0,Math.PI*2); ctx.fill();
  });
  requestAnimationFrame(draw);
}
resize(); init(); draw();

const langs = [
  {code:'ru',name:'Русский'},
  {code:'en',name:'English'},
  {code:'ua',name:'Українська'},
  {code:'es',name:'Español'},
  {code:'de',name:'Deutsch'},
  {code:'fr',name:'Français'},
  {code:'it',name:'Italiano'},
  {code:'pl',name:'Polski'},
  {code:'tr',name:'Türkçe'},
  {code:'zh',name:'中文'}
];
const i18n = {
  en:{ph:"Type a message...",send:"Send",notifOn:"Notifications enabled! Now you will receive signals and market news.", notifOff:"Notifications disabled.", notifAllow:"Allow notifications in browser settings.", notifError:"Notifications were denied.", menu:{profile:"My Profile",subscription:"Subscription",settings:"Settings",notifications:"Notifications",theme:"Theme",language:"Language",save:"Save Changes"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  ru:{ph:"Напишите сообщение...",send:"Отправить",notifOn:"Уведомления включены! Теперь вы будете получать сигналы и новости рынка.", notifOff:"Уведомления отключены.", notifAllow:"Разрешите уведомления в настройках браузера.", notifError:"Уведомления были отклонены.", menu:{profile:"Мой профиль",subscription:"Подписка",settings:"Настройки",notifications:"Уведомления",theme:"Тема",language:"Язык интерфейса",save:"Сохранить изменения"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  ua:{ph:"Введіть повідомлення...",send:"Надіслати",notifOn:"Сповіщення увімкнено! Тепер ви отримуватимете сигнали і новини ринку.", notifOff:"Сповіщення вимкнено.", notifAllow:"Дозвольте сповіщення у налаштуваннях браузера.", notifError:"Сповіщення були відхилені.", menu:{profile:"Мій профіль",subscription:"Підписка",settings:"Налаштування",notifications:"Сповіщення",theme:"Тема",language:"Мова інтерфейсу",save:"Зберегти зміни"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  es:{ph:"Escribe un mensaje...",send:"Enviar",notifOn:"¡Notificaciones activadas! Ahora recibirá señales y noticias del mercado.", notifOff:"Notificaciones desactivadas.", notifAllow:"Permita las notificaciones en la configuración del navegador.", notifError:"Las notificaciones fueron denegadas.", menu:{profile:"Mi perfil",subscription:"Suscripción",settings:"Configuraciones",notifications:"Notificaciones",theme:"Tema",language:"Idioma",save:"Guardar cambios"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  de:{ph:"Nachricht eingeben...",send:"Senden",notifOn:"Benachrichtigungen aktiviert! Sie erhalten nun Signale und Marktnachrichten.", notifOff:"Benachrichtigungen deaktiviert.", notifAllow:"Erlauben Sie Benachrichtigungen in den Browsereinstellungen.", notifError:"Benachrichtigungen wurden abgelehnt.", menu:{profile:"Mein Profil",subscription:"Abonnement",settings:"Einstellungen",notifications:"Benachrichtigungen",theme:"Thema",language:"Sprache",save:"Änderungen speichern"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  fr:{ph:"Tapez un message...",send:"Envoyer",notifOn:"Notifications activées ! Vous recevrez désormais des signaux et des actualités de marché.", notifOff:"Notifications désactivées.", notifAllow:"Autorisez les notifications dans les paramètres du navigateur.", notifError:"Les notifications ont été refusées.", menu:{profile:"Mon profil",subscription:"Abonnement",settings:"Paramètres",notifications:"Notifications",theme:"Thème",language:"Langue",save:"Enregistrer"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  it:{ph:"Scrivi un messaggio...",send:"Invia",notifOn:"Notifiche attivate! Ora riceverai segnali e notizie di mercato.", notifOff:"Notifiche disattivate.", notifAllow:"Consenti le notifiche nelle impostazioni del browser.", notifError:"Le notifiche sono state negate.", menu:{profile:"Il mio profilo",subscription:"Abbonamento",settings:"Impostazioni",notifications:"Notifiche",theme:"Tema",language:"Lingua",save:"Salva modifiche"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  pl:{ph:"Wpisz wiadomość...",send:"Wyślij",notifOn:"Powiadomienia włączone! Teraz będziesz otrzymywać sygnały i wiadomości rynkowe.", notifOff:"Powiadomienia wyłączone.", notifAllow:"Zezwól na powiadomienia w ustawieniach przeglądarki.", notifError:"Powiadomienia zostały odrzucone.", menu:{profile:"Mój profil",subscription:"Subskrypcja",settings:"Ustawienia",notifications:"Powiadomienia",theme:"Motyw",language:"Język",save:"Zapisz zmiany"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  tr:{ph:"Bir mesaj yazın...",send:"Gönder",notifOn:"Bildirimler etkin! Artık sinyaller ve piyasa haberleri alacaksınız.", notifOff:"Bildirimler devre dışı.", notifAllow:"Bildirimlere tarayıcı ayarlarından izin verin.", notifError:"Bildirimler reddedildi.", menu:{profile:"Profilim",subscription:"Abonelik",settings:"Ayarlar",notifications:"Bildirimler",theme:"Tema",language:"Dil",save:"Değişiklikleri Kaydet"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"},
  zh:{ph:"输入消息...",send:"发送",notifOn:"通知已启用！您将收到信号和市场新闻。", notifOff:"通知已禁用。", notifAllow:"请在浏览器设置中允许通知。", notifError:"通知被拒绝。", menu:{profile:"我的资料",subscription:"订阅",settings:"设置",notifications:"通知",theme:"主题",language:"语言",save:"保存更改"}, tradeTitle:"NEURONA", tradeSubtitle:"Trade AI Bot"}
};
let lang = (localStorage.getItem('neurona_lang')||navigator.language.slice(0,2));
if(!i18n[lang]) lang='en';
let settingsBuffer = {
  theme: localStorage.getItem('neurona_theme') === 'dark',
  notif: localStorage.getItem('neurona_notif') === 'on',
  lang: lang
};
let lastSavedSettings = {...settingsBuffer};

const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const msgsContainer = document.getElementById('messages');
const scrollDownBtn = document.getElementById('scroll-down');
const inputArea = document.querySelector('.input-area');
const sideMenu = document.getElementById('sideMenu');
const sideMenuBg = document.getElementById('sideMenuBg');
const burger = document.getElementById('burgerBtn');
const closeBtn = document.getElementById('sideCloseBtn');
const settingsBtn = document.getElementById('settingsBtn');
const settingsGroup = document.getElementById('settingsGroup');
const themeSwitch = document.getElementById('themeSwitch');
const notifSwitch = document.getElementById('notifSwitch');
const langRow = document.getElementById('langRow');
const langList = document.getElementById('langList');
const currLangName = document.getElementById('currLangName');
const currLangGray = document.getElementById('currLangGray');
const langArrow = document.getElementById('langArrow');
const mainLogo = document.getElementById('mainLogo');
const loaderLogo = document.getElementById('loaderLogo');
const mainTitle = document.getElementById('mainTitle');
const loaderTitle = document.getElementById('loaderTitle');
const loaderSubtitle = document.getElementById('loaderSubtitle');
const sideMenuList = document.getElementById('sideMenuList');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const notifPopup = document.getElementById('notifPopup');
const notifPopupMsg = document.getElementById('notifPopupMsg');
const aiVersionSelector = document.getElementById('aiVersionSelector');
const aiVersionBtn = document.getElementById('aiVersionBtn');
const aiVersionArrow = document.getElementById('aiVersionArrow');
const aiVersionDropdown = document.getElementById('aiVersionDropdown');
const mainChatContainer = document.getElementById('mainChatContainer');
const tradeWindows = document.getElementById('tradeWindows');
const tradeTitle = document.getElementById('tradeTitle');
const tradeSubtitle = document.getElementById('tradeSubtitle');
const tradeNewsList = document.getElementById('tradeNewsList');
const tradeSignalList = document.getElementById('tradeSignalList');

function updateMenuI18n() {
  const m = i18n[settingsBuffer.lang].menu;
  sideMenuList.querySelector('[data-menu=profile] .menu-text').textContent=m.profile;
  sideMenuList.querySelector('[data-menu=subscription] .menu-text').textContent=m.subscription;
  settingsBtn.querySelector('.menu-text').textContent = m.settings;
  settingsGroup.querySelectorAll('.side-switch-row')[0].querySelector('.menu-text').textContent = m.notifications;
  settingsGroup.querySelectorAll('.side-switch-row')[1].querySelector('.menu-text').textContent = m.theme;
  settingsGroup.querySelectorAll('.side-switch-row')[2].querySelector('.menu-text').textContent = m.language;
  saveSettingsBtn.textContent = m.save;
}
function updateLangName(){
  let found = langs.find(l=>l.code===settingsBuffer.lang);
  currLangName.textContent = found ? found.name : settingsBuffer.lang;
  currLangGray.textContent = `(${settingsBuffer.lang})`;
}
function updatePlaceholders(){
  input.placeholder = i18n[settingsBuffer.lang].ph;
  sendBtn.textContent = i18n[settingsBuffer.lang].send;
  tradeTitle.textContent = i18n[settingsBuffer.lang].tradeTitle;
  tradeSubtitle.textContent = i18n[settingsBuffer.lang].tradeSubtitle;
}
updateLangName();
updateMenuI18n();
updatePlaceholders();

function setTheme(dark, fast){
  document.body.classList.toggle('dark',dark);
  mainLogo.style.filter = dark ? "invert(1)" : "";
  loaderLogo.style.filter = dark ? "invert(1)" : "";
  mainTitle.style.color = dark ? "#fff" : "#000";
  loaderTitle.style.color = dark ? "#fff" : "#000";
  loaderSubtitle.style.color = dark ? "#fff" : "#222";
  Array.from(burger.children).forEach(span=>span.style.background=dark?'#fff':'#000');
  themeSwitch.classList.toggle('on',dark);
  if(fast){
    document.body.style.transition = "none";
    mainLogo.style.transition = "none";
    loaderLogo.style.transition = "none";
    mainTitle.style.transition = "none";
    loaderTitle.style.transition = "none";
    loaderSubtitle.style.transition = "none";
  } else {
    document.body.style.transition = "";
    mainLogo.style.transition = "";
    loaderLogo.style.transition = "";
    mainTitle.style.transition = "";
    loaderTitle.style.transition = "";
    loaderSubtitle.style.transition = "";
  }
}
function setNotif(on){
  notifSwitch.classList.toggle('on',on);
}
function showSaveBtnIfChanged() {
  if (settingsBuffer.theme !== lastSavedSettings.theme ||
      settingsBuffer.notif !== lastSavedSettings.notif ||
      settingsBuffer.lang !== lastSavedSettings.lang) {
    saveSettingsBtn.classList.remove('hide');
    saveSettingsBtn.style.display = '';
    setTimeout(()=>saveSettingsBtn.style.opacity='1',10);
  } else {
    saveSettingsBtn.style.opacity = "0";
    setTimeout(()=>{saveSettingsBtn.classList.add('hide');}, 320);
  }
}
function showNotifPopup(msg, error){
  notifPopupMsg.textContent = msg;
  notifPopup.style.background = error?'#e22c2c':'#0e0';
  notifPopup.classList.add('show');
  setTimeout(()=>notifPopup.classList.remove('show'),2200);
}
burger.onclick = ()=>{ sideMenu.classList.add('active'); sideMenuBg.classList.add('active'); }
closeBtn.onclick = ()=>{ sideMenu.classList.remove('active'); sideMenuBg.classList.remove('active'); }
sideMenuBg.onclick = ()=>{ sideMenu.classList.remove('active'); sideMenuBg.classList.remove('active'); }
document.addEventListener('keydown', e=>{
  if(e.key==='Escape' && sideMenu.classList.contains('active')) {
    sideMenu.classList.remove('active'); sideMenuBg.classList.remove('active');
  }
});
let settingsOpen = false;
settingsBtn.onclick = function() {
  settingsOpen = !settingsOpen;
  settingsGroup.classList.toggle('open',settingsOpen);
  settingsBtn.querySelector('.side-arrow').style.transform = settingsOpen ? "rotate(180deg)" : "rotate(0deg)";
  if(!settingsOpen) {
    langList.classList.remove('show');
    langArrow.classList.remove('open');
  }
};
themeSwitch.onclick = ()=>{
  settingsBuffer.theme = !settingsBuffer.theme;
  setTheme(settingsBuffer.theme, true);
  showSaveBtnIfChanged();
};
notifSwitch.onclick = ()=>{
  settingsBuffer.notif = !settingsBuffer.notif;
  setNotif(settingsBuffer.notif);
  showSaveBtnIfChanged();
  if (settingsBuffer.notif) {
    if (window.Notification && Notification.permission !== "granted") {
      Notification.requestPermission().then(res=>{
        if (res === "granted") {
          showNotifPopup(i18n[settingsBuffer.lang].notifOn);
        } else {
          settingsBuffer.notif = false;
          setNotif(false);
          showNotifPopup(i18n[settingsBuffer.lang].notifError, true);
        }
      });
    } else if (window.Notification && Notification.permission === "granted") {
      showNotifPopup(i18n[settingsBuffer.lang].notifOn);
    } else {
      showNotifPopup(i18n[settingsBuffer.lang].notifAllow, true);
    }
  } else {
    showNotifPopup(i18n[settingsBuffer.lang].notifOff, true);
  }
};
function renderLangList(){
  langList.innerHTML = '';
  langs.forEach(l=>{
    const li = document.createElement('div');
    li.className = 'side-lang-item' + (l.code===settingsBuffer.lang?' active':'');
    li.textContent = l.name;
    li.onclick = ()=>{
      settingsBuffer.lang = l.code;
      updateLangName();
      updateMenuI18n();
      updatePlaceholders();
      langList.classList.remove('show');
      langArrow.classList.remove('open');
      showSaveBtnIfChanged();
    };
    langList.appendChild(li);
  });
}
renderLangList();
langRow.onclick = (e)=>{
  renderLangList();
  langList.classList.toggle('show');
  langArrow.classList.toggle('open', langList.classList.contains('show'));
  e.stopPropagation();
};
document.body.addEventListener('click', ()=>{ langList.classList.remove('show'); langArrow.classList.remove('open'); });
saveSettingsBtn.onclick = ()=>{
  localStorage.setItem('neurona_theme', settingsBuffer.theme ? 'dark' : 'light');
  localStorage.setItem('neurona_notif', settingsBuffer.notif ? 'on' : 'off');
  localStorage.setItem('neurona_lang', settingsBuffer.lang);
  lastSavedSettings = {...settingsBuffer};
  saveSettingsBtn.style.opacity = "0";
  setTimeout(()=>saveSettingsBtn.classList.add('hide'), 320);
  updateMenuI18n();
  updatePlaceholders();
};
function loadSettings(){
  setTheme(settingsBuffer.theme, true);
  setNotif(settingsBuffer.notif);
  updateLangName();
  renderLangList();
  updateMenuI18n();
  updatePlaceholders();
}
loadSettings();
(function applyThemeOnLoad(){
  let dark = settingsBuffer.theme;
  setTheme(dark, true);
})();

let messages = [], typingProcess = null, botIsTyping = false;
function saveHistory(){ localStorage.setItem('neurona_history', JSON.stringify(messages)); }
function loadHistory(){
  const h = JSON.parse(localStorage.getItem('neurona_history')||'[]');
  if(h.length){
    messages=h;
    msgsContainer.innerHTML = '';
    h.forEach(m=> addMessage(m.content,m.role,m.time));
    scrollChatToBottom(true);
  }
}
document.body.style.opacity = "1";
window.addEventListener('load', ()=>{
  document.getElementById('top-bar').classList.add('hide');
  setTimeout(()=>{
    document.getElementById('loader').classList.add('hide');
    setTimeout(()=>{
      document.body.classList.add('shown');
      document.getElementById('loader').style.display='none';
      document.getElementById('top-bar').classList.remove('hide');
      loadHistory();
      setTimeout(()=>scrollChatToBottom(true), 300);
    }, 1000);
  }, 4000);
});
function formatBotMessage(text) {
  text = text.replace(/[\u{FE00}-\u{FE0F}]/gu, "");
  text = text.replace(/\uFFFD/g, "");
  text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, function(_, name, url) {
    let dark = document.body.classList.contains('dark');
    return `<a href="${url}" target="_blank" style="color:${dark ? '#68a6ff' : '#286be6'};font-size:.98em;"><b>${name}</b></a>`;
  });
  text = text.replace(/\*\*([^\*]+)\*\*/g, '<b>$1</b>');
  text = text.replace(/(^|\n)((?:\d+\.\s.*\n?)+)/gm, (m, p1, block) => {
    const items = block.trim().split(/\n/).filter(Boolean);
    let out = '<ol>';
    for(let i=0; i<items.length; ++i){
      out += `<li>${items[i].replace(/^\d+\.\s?/, '')}</li>`;
    }
    out += '</ol>';
    return p1 + out;
  });
  text = text.replace(/(^|\n)((?:^[-•]\s.+\n?)+)/gm, (m, p1, block) => {
    const items = block.trim().split(/\n/).filter(Boolean);
    let out = '<ul>';
    for(let i=0; i<items.length; ++i){
      out += '<li>' + items[i].replace(/^[-•]\s?/, '').trim() + '</li>';
    }
    out += '</ul>';
    return p1 + out;
  });
  text = text.replace(/\n{2,}/g, '</p><p>');
  text = text.replace(/\n/g, '<br>');
  if (!/^<p>/.test(text)) text = '<p>' + text;
  text = text.replace(/(<ol>|<ul>)/g, '</p>$1<p>');
  text = text.replace(/<\/ol>|<\/ul>/g, '$&<p>');
  text = text.replace(/<p><\/p>/g, '');
  return text;
}
const etapRegex = /етап|этап|fastapi|huggingface|mistral|openchat|sqlite|redis|tauri|docker|ci\/cd|github actions|s3|r2|cloudflare|infra|api|модули|ocr|tesseract|coingecko|newsapi|health/;
const etapFullAnswer =
`<b>Все этапы, архитектура и модули, которые вы перечислили, уже реализованы и интегрированы в NEURONA!</b><br>
Моя система поддерживает:<br>
<ul>
<li>LLM через HuggingFace (Mistral, OpenChat)</li>
<li>Контекстную память на SQLite/Redis</li>
<li>Поддержку FastAPI, Docker, CI/CD, облачные хранилища</li>
<li>OCR (Tesseract), интеграции с CoinGecko, NewsAPI, Binance</li>
<li>Модульную архитектуру, защиту пользователей и масштабируемость</li>
</ul>`;
function addMessage(text, role, time){
  const msg = document.createElement('div');
  msg.className = 'message ' + role;
  msg.innerHTML = `<div class="msg-content">${role==="bot"?formatBotMessage(text):text}</div>` +
    `<span class="msg-time">${time||new Date().toLocaleTimeString()}</span>`;
  msgsContainer.appendChild(msg);
}
function scrollChatToBottom(force){
  if(force||msgsContainer.scrollHeight-msgsContainer.scrollTop-msgsContainer.clientHeight<120)
    msgsContainer.scrollTop=msgsContainer.scrollHeight;
}
input.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){
    e.preventDefault();
    sendBtn.click();
  }
});
sendBtn.onclick = ()=>{
  let val = input.value.trim();
  if(!val) return;
  addMessage(val,"user",new Date().toLocaleTimeString());
  messages.push({content:val,role:"user",time:new Date().toLocaleTimeString()});
  saveHistory();
  input.value="";
  addMessage('<span class="typing-dots"><span class="tdot tdot1"></span><span class="tdot tdot2"></span><span class="tdot tdot3"></span></span>',"bot");
  scrollChatToBottom(true);
  setTimeout(()=>{
    msgsContainer.lastChild.remove();
    let response = etapRegex.test(val.toLowerCase()) ? etapFullAnswer : "Ответ ИИ...";
    addMessage(response,"bot",new Date().toLocaleTimeString());
    messages.push({content:response,role:"bot",time:new Date().toLocaleTimeString()});
    saveHistory();
    scrollChatToBottom(true);
  },1500);
};
scrollDownBtn.onclick=()=>{scrollChatToBottom(true);}
msgsContainer.addEventListener('scroll',()=>{
  scrollDownBtn.classList.toggle('show',msgsContainer.scrollHeight-msgsContainer.scrollTop-msgsContainer.clientHeight>80);
});

let currentAiVersion = "neurona1";
aiVersionBtn.onclick = (e)=>{
  aiVersionDropdown.classList.toggle('show');
  aiVersionArrow.style.transform = aiVersionDropdown.classList.contains('show') ? "rotate(180deg)" : "rotate(0deg)";
  e.stopPropagation();
};
document.body.addEventListener('click',()=>{ aiVersionDropdown.classList.remove('show'); aiVersionArrow.style.transform=""; });
[...aiVersionDropdown.children].forEach(item=>{
  item.onclick = ()=>{
    if(item.dataset.value!==currentAiVersion){
      [...aiVersionDropdown.children].forEach(x=>x.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('aiVersionBtnText').textContent = item.textContent.split('\n')[0];
      aiVersionDropdown.classList.remove('show');
      aiVersionArrow.style.transform="";
      if(item.dataset.value==="neurona1"){
        switchToChat();
      }else{
        switchToTrade();
      }
    }
  };
});
function switchToChat(){
  currentAiVersion = "neurona1";
  mainChatContainer.style.display = "";
  tradeWindows.style.display = "none";
  burger.style.display = "";
  sideMenu.style.display = "";
  mainLogo.src = "https://i.ibb.co/Mk4WpHL9/25-1.png";
  mainTitle.textContent = "NEURONA";
}
function switchToTrade(){
  currentAiVersion = "tradeai";
  burger.style.display = "none";
  sideMenu.classList.remove('active');
  sideMenuBg.classList.remove('active');
  sideMenu.style.display = "none";
  mainChatContainer.style.display = "none";
  tradeWindows.style.display = "";
  mainLogo.src = "https://i.ibb.co/Mk4WpHL9/25-1.png";
  mainTitle.textContent = i18n[settingsBuffer.lang].tradeTitle;
  tradeSubtitle.textContent = i18n[settingsBuffer.lang].tradeSubtitle;
  showLoaderAndLoadTrade();
}
function showLoaderAndLoadTrade(){
  document.getElementById('loader').style.display = '';
  setTimeout(()=>{
    document.getElementById('loader').classList.add('hide');
    setTimeout(()=>{document.getElementById('loader').style.display='none';},1100);
    loadTradeNews();
    loadTradeSignals();
  },4000);
}
function translateText(text,to,cb){
  if(to==="en"){cb(text);return;}
  fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${to}&dt=t&q=`+encodeURIComponent(text))
  .then(r=>r.json()).then(d=>cb(d[0].map(x=>x[0]).join(''))).catch(()=>cb(text));
}
const newsFeeds = [
  {name:"CryptoPanic",url:"https://cryptopanic.com/api/v1/posts/?auth_token=demo&public=true"},
  {name:"CoinDesk",url:"https://feeds.coinfeed.com/rss/coindesk"},
  {name:"Binance Blog",url:"https://www.binance.com/en/blog/rss"},
  {name:"NewsAPI",url:"https://newsapi.org/v2/top-headlines?sources=crypto-coins-news&apiKey=demo"},
  {name:"Cointelegraph",url:"https://cointelegraph.com/rss"},
  {name:"CryptoCompare",url:"https://min-api.cryptocompare.com/data/v2/news/?lang=EN"},
  {name:"Yahoo Crypto",url:"https://finance.yahoo.com/news/rss/cryptocurrencies"}
];
function fetchNewsFeed(newsUrl,cb){
  fetch("https://api.allorigins.win/get?url="+encodeURIComponent(newsUrl))
    .then(r=>r.json()).then(data=>{
      let parser = new DOMParser();
      let doc = parser.parseFromString(data.contents,"text/xml");
      let items = [...doc.querySelectorAll("item")].slice(0,7).map(item=>({
        title:item.querySelector("title")?item.querySelector("title").textContent:"",
        link:item.querySelector("link")?item.querySelector("link").textContent:"",
        source:(item.querySelector("source")?item.querySelector("source").textContent:""),
        date:item.querySelector("pubDate")?item.querySelector("pubDate").textContent:""
      }));
      cb(items);
    }).catch(()=>cb([]));
}
function loadTradeNews(){
  tradeNewsList.innerHTML = "";
  let langCode = settingsBuffer.lang;
  let allNews = [];
  let loaded = 0;
  newsFeeds.forEach(feed=>{
    fetchNewsFeed(feed.url,items=>{
      if(items.length){
        allNews = allNews.concat(items.map(i=>({...i,source:feed.name})));
      }
      loaded++;
      if(loaded===newsFeeds.length){
        allNews = allNews.sort((a,b)=>(new Date(b.date)-new Date(a.date))).slice(0,12);
        let render = ()=> {
          tradeNewsList.innerHTML = "";
          allNews.forEach(news=>{
            translateText(news.title,langCode,translated=>{
              let el = document.createElement("div");
              el.className="trade-news-item";
              el.innerHTML = `<a href="${news.link}" target="_blank" class="trade-news-link">${translated}</a>
                <span class="trade-news-source">${news.source}</span>
                <span class="trade-news-time">${news.date?new Date(news.date).toLocaleString():''}</span>`;
              tradeNewsList.appendChild(el);
            });
          });
        };
        render();
      }
    });
  });
}
const binanceKey = "SSsOLsTYiALZWxd8pruKEB6orIlWuhtnBpBzktKg69w65SLZBcp3mlE3KUDY9RCU";
const binanceSecret = "LkJE5S0NgGZaeuOkA56zFOaLhWQmFJBbOVJc3r5YsnnircDkZ2d3FOtSrTMe30o2";
function loadTradeSignals(){
  tradeSignalList.innerHTML = "";
  function addSignal(signal){
    let el = document.createElement("div");
    el.className="trade-signal-item";
    el.innerHTML = `<span class="trade-signal-dot ${signal.type}"></span>
      <span class="trade-signal-label ${signal.type}">${signal.type==="long"?"LONG":"SHORT"}</span>
      <span class="trade-signal-entry">${signal.entry}</span>
      <span class="trade-signal-tp">TP: ${signal.tp}</span>
      <span class="trade-signal-sl">SL: ${signal.sl}</span>
      <span class="trade-signal-tf">TF: ${signal.tf}</span>
      <span class="trade-signal-time">${signal.time}</span>
      <div class="trade-signal-comment">${signal.comment}</div>`;
    tradeSignalList.appendChild(el);
  }
  function randomSignal(){
    let t = Math.random()>0.5?"long":"short";
    let price = (Math.random()*8000+25000).toFixed(2);
    let tp = (parseFloat(price)+(t==="long"?Math.random()*1000:-(Math.random()*1000))).toFixed(2);
    let sl = (parseFloat(price)+(t==="long"?-(Math.random()*600):Math.random()*600)).toFixed(2);
    let tf = ["M15","H1","H4","D1"][Math.floor(Math.random()*4)];
    let now = new Date();
    let comment = t==="long"? "Потенциал роста, позитивные сигналы по BTC." : "Возможен откат, осторожно с шортами!";
    translateText(comment,settingsBuffer.lang,cmt=>{
      addSignal({
        type:t, entry:price, tp:tp, sl:sl, tf:tf,
        time:now.toLocaleTimeString(), comment:cmt
      });
    });
    if(settingsBuffer.notif && window.Notification && Notification.permission==="granted"){
      let notifText = (t==="long"?"LONG":"SHORT")+" BTC "+price+" TP:"+tp+" SL:"+sl+" TF:"+tf;
      new Notification("NEURONA Signal", {body:notifText, icon:"https://i.ibb.co/XfKRzvcy/27.png"});
    }
  }
  for(let i=0;i<5;i++) randomSignal();
  let typing = document.createElement('div');
  typing.className="signal-typing";
  typing.innerHTML='<span class="typing-dots"><span class="tdot tdot1"></span><span class="tdot tdot2"></span><span class="tdot tdot3"></span></span>';
  tradeSignalList.appendChild(typing);
  setInterval(()=>{
    if(currentAiVersion==="tradeai"){
      tradeSignalList.removeChild(tradeSignalList.lastChild);
      randomSignal();
      tradeSignalList.appendChild(typing);
      tradeSignalList.scrollTop = tradeSignalList.scrollHeight;
    }
  },9000);
}
</script>
</body>
</html>
